■ 新規ユーザーへの権限設定手順


参考
https://docs.microsoft.com/ja-jp/power-platform/admin/grant-users-access


１．環境へのアクセス権限を与える

    参考：
    https://docs.microsoft.com/ja-jp/power-platform/admin/add-users-to-environment

    通常は組織内のすべてのユーザーが自動的に環境に追加される。
    （後述の「２．セキュリティグループ」が設定されている場合は除く）

    ＊ユーザーが環境に追加されていることの確認方法

    PowerAppsの「管理センター」を開く
    https://admin.powerplatform.microsoft.com/

    環境メニューから設定したい環境を開く

    「アクセス > ユーザー > すべて表示」をクリック

    追加したいユーザーが表示されていることを確認する。
    ＊表示されていない場合は、左上の「ユーザーの追加」から追加する

    PowerAppsのピッカー（右上の環境を選択する場所）に環境を
    が表示するためには、以下のいずれかの条件を満たす必要がある。

        １．環境の環境管理者ロールのメンバーです。
        ２．環境の環境作成者ロールのメンバーです。
        ３．環境の環境管理者または環境作成者ではありませんが、
        　　環境内の少なくとも 1 つのアプリへの共同作成者アクセスが付与されています。 
        　　この場合、この環境でアプリを作成することはできず、共有されている
        　　既存のアプリのみを変更できます。 


２．セキュリティグループ

    環境とユーザーを直接紐づけることよりも、
    環境を「セキュリティグループ（Microsoft 365のユーザー管理機能）」に関連付けることで、
    特定のユーザーに対して環境のアクセスを制限することが推奨*されている
    
    ＊推奨されている理由
    　大規模組織の場合、１．の方法による環境へのユーザー自動追加には処理時間がかかる
    　ユーザーと環境の紐づけ管理が「Microsoft 365管理センター」で行える。


    設定方法は下記ページを参照
    https://docs.microsoft.com/ja-jp/power-platform/admin/control-user-access
    

    設定には Microsoft365 の管理者権限が必要となる。
    今回は Microsoft365 管理ユーザーをお借りしていないため、設定なし。


３．定義済みセキュリティロール

    参考：
    https://docs.microsoft.com/ja-jp/power-platform/admin/database-security

    通常、ユーザーを環境に追加すると環境自体へのアクセス権のみが付与され、
    環境内のリソース (アプリとデータ) に対するアクセス権は付与されない。 

    リソースへにアクセスをするには、セキュリティロールをユーザーに割り当てる。

    環境には、あらかじめ「定義済みセキュリティロール」が用意されている。

    定義済みセキュリティロールの例：
    環境管理者、環境作成者、システム管理者、システムカスタマイザ、
    CommonDataServiceユーザー、代理人

    特に重要な定義済みセキュリティロール３つ
    
    【環境管理者ロール】
    以下を含む環境ですべての管理アクションを実行できます。
    ユーザーを、環境管理者または環境作成者ロールのいずれかに、
    追加またはそれらから削除します。
    環境用の Common Data Service データベースをプロビジョニングする。 
    データベースがプロビジョニングされた後、システム カスタマイザーのロールは環境の
    管理者にも割り当てられ、環境のデータに対するアクセス権を付与する必要があります。
    環境内に作成されたすべてのリソースを表示および管理します。
    
    【システム管理者】
    システム管理者はすべての権限が与えられており、変更できない。

    【環境作成者ロール】
    Microsoft Power Automate を使用することで、
    アプリ、接続、カスタム API、ゲートウェイ、フローなど、
    環境に関連付けられた新たなリソースを作成できます。 
    ただし、このロールには環境内のデータにアクセスする権限はありません。
    
    【Common Data Service ユーザー】
    環境内でアプリを実行して、自分が所有するレコードに対して一般的なタスクを実行できる。
    これは、ユーザー定義以外のエンティティにのみ適用される。
    
    【Approvals User】

４．独自のセキュリティロールの作成

    アプリがカスタムエンティティを使用している場合、エンティティ権限を明示的に指定する必要がある。
    そのためには、新しいセキュリティーロールを作成し設定する。

    参考：
    https://docs.microsoft.com/ja-jp/powerapps/maker/model-driven-apps/share-model-driven-app
    https://docs.microsoft.com/ja-jp/power-platform/admin/security-roles-privileges#security-roles

    ロールの管理画面を開く

    （方法１）
    ソリューションの画面を開く
    画面上部の「新規」より「セキュリティロール」を選択する

    （方法２）
    CommonDataService Userをコピーして新しいロールを作成する

    使用するエンティティのアクセス権限を与える

        PowerAppsの「管理センター」を開く
        https://admin.powerplatform.microsoft.com/

        環境メニューから設定したい環境を開く

        「アクセス > セキュリティロール > すべて表示」をクリック

        「新しいロール」をクリック
        or
        基にしたいロールの「…」から「コピー」をクリック

        作成したロールの「編集」をクリック

        「ユーザーエンティティ」タブを表示
        
        使用するエンティティのアクセス許可を与える


５．ユーザーへのセキュリティロールの割り当て

    PowerAppsの「管理センター」を開く
    https://admin.powerplatform.microsoft.com/

    環境メニューから設定したい環境を開く

    （方法１ *対象ユーザーの部署がわかる場合）
    「アクセス > セキュリティロール > すべて表示」をクリック
    部署ドロップダウンリストでユーザーの部署を選択する。
    ユーザーに割り当てたいセキュリティロールを選択する
    左上の「ユーザーの追加」をクリック

    （方法２）
    「アクセス > ユーザー > すべて表示」をクリック
    ロールを割り当てたいユーザーを選択する。
    画面上部の「ロールの管理」をクリック
    割り当てたい「セキュリティ ロール」を選択する




４．モデル駆動アプリへのアクセス権限を与える（セキュリティロールの設定）

    参考：
    https://docs.microsoft.com/ja-jp/powerapps/maker/model-driven-apps/share-model-driven-app

    アプリの設定で、どのセキュリティロールがあれば利用可能かを設定する。

    PowerAppsのホームを開く
    https://make.powerapps.com

    「アプリ」をクリックする。

    共有したいアプリの「…」をクリっく

    「共有」をクリック

    アプリケーションを選択し、左側の「CommonDataService」のドロップダウンリストをクリックする。

    アプリを共有するロールを選択する。


    モデル駆動アプリの編集画面を開く。
    画面右側の、プロパティ タブをクリックします。
    統一インターフェイス URL をコピーします。




５．レコードレベルのセキュリティの設定

    レコードの「所属部署」「所有チーム」「所有ユーザー」「所有者」で
    制限？


    エンティティ所有権
    https://docs.microsoft.com/ja-jp/dynamics365/customerengagement/on-premises/developer/introduction-entities#entity-ownership



６．フィールドセキュリティの設定

    フィールドレベルの権限制御は「業務ルール」を使う方法と
    「フィールドセキュリティプロファイル」を使う方法がある。


    ■「業務ルール」を使う場合

        同じエンティティ内のフィールド値の条件によって
        編集可／不可や表示／非表示などを切り替える場合には
        業務ルールが使用できる。

        https://docs.microsoft.com/ja-jp/powerapps/maker/common-data-service/data-platform-create-business-rule


    ■「フィールドセキュリティプロファイル」を使う場合

        フィールド レベル セキュリティを使用して、特定のフィールドへのアクセスを制御できる。
        フィールド レベル セキュリティのスコープは組織全体であり、
        すべてのデータ アクセス要求に適用される。

        参考：
        https://docs.microsoft.com/ja-jp/power-platform/admin/enable-disable-security-field
        https://docs.microsoft.com/ja-jp/power-platform/admin/field-level-security
        https://docs.microsoft.com/ja-jp/power-platform/admin/set-up-security-permissions-field


        設定の手順は
        1) フィールドの「フィールードセキュリティ設定」を有効にする。
        2) セキュリティプロファイルを関連づける
        という手順で行う。

        セキュリティが有効になっているフィールドに、プロファイルが割り当てられていなければ、
        システム管理者セキュリティ ロールを持つユーザーのみがこのフィールドにアクセスできる。


    ■ フィールドセキュリティ設定の有効化

        エンティティの編集画面を開く

        フィールド名をクリックし、右側の編集パネルで
        「詳細オプション > フィールドセキュリティを有効にする」
        にチェックを入れる。


    ■ セキュリティプロファイルの作成

        ソリューションの画面を開く

        左上の「新規」から「フィールドセキュリティプロファイル」を選択

        新規 をクリック

        わかりやすい名前を入力し、保存 を選択。

        ユーザー を選択し、追加 を選択し、連絡先フォームの携帯電話番号への読み取りアクセス権を付与するユーザーを選択し、続いて 追加 を選択します。

        ヒント

        ユーザーを個別に追加する代わりに、読み取りアクセスを許可するすべてのユーザーが含まれる 1 つまたは複数のチームを作成します。

        フィールドのアクセス許可 を選択し、携帯電話 を選択し、編集 を選択します。読み取りを許可 の横で はい を選択し、OK を選択します。